name: Add issues to DITC TODO project

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue-number:
        description: Optional issue number to backfill (leave blank for all)
        required: false
        type: string
      state:
        description: Issue state when backfilling all (open or all)
        required: false
        default: all
        type: string

permissions:
  contents: read

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    env:
      PROJECT_ORG: Day-in-the-Country-LLC
      PROJECT_TITLE: DITC TODO
    steps:
      - name: Resolve DITC TODO project ID
        env:
          GH_TOKEN: ${{ secrets.DITC_PROJECT_TOKEN }}
        run: |
          set -euo pipefail
          project_query='query($org:String!, $title:String!){ organization(login:$org){ projectsV2(first:100, query:$title){ nodes { id title }}}}'
          project_id=$(gh api graphql \
            -f query="$project_query" \
            -f org="${PROJECT_ORG}" \
            -f title="${PROJECT_TITLE}" \
            --jq '.data.organization.projectsV2.nodes[] | select(.title == env.PROJECT_TITLE) | .id' \
            | head -n 1)

          if [[ -z "${project_id}" || "${project_id}" == "null" ]]; then
            echo "Unable to resolve project ID for ${PROJECT_ORG}/${PROJECT_TITLE}." >&2
            exit 1
          fi

          echo "Resolved project ID ${project_id}."
          echo "PROJECT_ID=${project_id}" >> "${GITHUB_ENV}"
      - name: Add opened issue to project board
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.DITC_PROJECT_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"

          issue_id="${ISSUE_ID}"
          if [[ -z "${issue_id}" || "${issue_id}" == "null" ]]; then
            issue_id=$(gh api "repos/${owner}/${repo}/issues/${ISSUE_NUMBER}" --jq '.node_id')
          fi

          if [[ -z "${issue_id}" || "${issue_id}" == "null" ]]; then
            echo "Unable to resolve issue node ID for #${ISSUE_NUMBER}." >&2
            exit 1
          fi

          add_query='mutation($projectId:ID!, $contentId:ID!){ addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){ item { id }}}'
          gh api graphql -f query="$add_query" -f projectId="${PROJECT_ID}" -f contentId="${issue_id}" >/dev/null
          echo "Added issue #${ISSUE_NUMBER} to ${PROJECT_TITLE}."
      - name: Backfill issues to project board
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.DITC_PROJECT_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue-number }}
          ISSUE_STATE: ${{ github.event.inputs.state }}
        run: |
          set -euo pipefail
          echo "Starting backfill for ${GITHUB_REPOSITORY}"
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"
          echo "Resolved project ID ${PROJECT_ID} for ${PROJECT_ORG}/${PROJECT_TITLE}."

          if [[ -n "${ISSUE_NUMBER}" ]]; then
            issue_payload=$(gh api "repos/${owner}/${repo}/issues/${ISSUE_NUMBER}" --jq '{number: .number, id: .node_id}')
            issue_list=$(printf '%s\n' "${issue_payload}")
          else
            state="${ISSUE_STATE:-open}"
            issue_list=$(gh api --paginate "repos/${owner}/${repo}/issues?state=${state}&per_page=100" \
              --jq '.[] | select(.pull_request | not) | {number: .number, id: .node_id}')
          fi

          if [[ -z "${issue_list}" ]]; then
            echo "No issues found to backfill."
            exit 0
          fi

          add_query='mutation($projectId:ID!, $contentId:ID!){ addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){ item { id }}}'
          echo "Backfilling issues into DITC TODO."
          while IFS= read -r issue; do
            number=$(echo "${issue}" | jq -r '.number')
            content_id=$(echo "${issue}" | jq -r '.id')
            if [[ -z "${content_id}" || "${content_id}" == "null" ]]; then
              echo "Skipping issue #${number}; missing node_id." >&2
              continue
            fi
            echo "Adding issue #${number} to project board."
            if ! gh api graphql -f query="$add_query" -f projectId="${PROJECT_ID}" -f contentId="${content_id}" >/dev/null 2>&1; then
              echo "Issue #${number} may already be in the project."
            fi
          done <<< "${issue_list}"
